---
- name: Add Sury PHP repository key
  apt_key:
    url: https://packages.sury.org/php/apt.gpg
    state: present

- name: Add Sury PHP repository
  apt_repository:
    repo: "deb https://packages.sury.org/php/ {{ ansible_distribution_release }} main"
    state: present

- name: Update cache
  apt:
    update_cache: yes
  changed_when: false

- name: Install PHP packages
  apt:
    pkg: "{{ item }}"
    state: present
  loop:
    - php
    - php-fpm
    - "{{ php_packages | default([]) }}"

- name: Get the version of the currently running PHP installation
  shell: "php -v | head -n 1 | awk '{print $2}' | cut -d. -f1,2"
  register: php_version_raw
  changed_when: false

- name: Set fact php_version
  set_fact:
    php_version: "{{ php_version_raw.stdout }}"
